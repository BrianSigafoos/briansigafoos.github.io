<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><title>FastAPI for ML inference - Brian Sigafoos</title>
<link rel=stylesheet href="/css/main.min.9dccf334550d3f0f50f42076b75ac4f739fab5bccb06e4559a7b5a0e4d3c1dd0.css" integrity="sha256-nczzNFUNPw9Q9CB2t1rE9zn6tbzLBuRVmntaDk08HdA="><script src=/main.js></script><link rel="shortcut icon" href=/favicon.png?20190809><link rel=apple-touch-icon href=/apple-touch-icon.png?20190809></head><body data-controller=color-scheme class="text-color bg-bright antialiased leading-normal"><div class="border-b border-gray py-4 w-full"><div class="container max-w-4xl"><div class="flex items-center justify-between font-mono"><a href=https://briansigafoos.com/ class="text-primary font-extrabold">Brian Sigafoos</a><div class="flex items-center"><a href=/about class="text-color font-extrabold block">About me</a><div class="flex ml-4"><button type=button data-action=color-scheme#toggleScheme aria-label="Toggle dark mode" title="Toggle dark mode" class="py-1 px-2 cursor-pointer text-color">
<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg>
</button>
<button type=button data-action=color-scheme#toggleColor aria-label="Change primary color" title="Change primary color" class="py-1 px-2 cursor-pointer text-primary"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828.0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg></button></div></div></div></div></div><div class="container my-12 md:my-16 !max-w-4xl prose md:prose-lg lg:prose-xl prose-custom"><h1>FastAPI for ML inference</h1><p class="mt-4 text-lg md:text-xl lg:text-2xl text-muted">How to use FastAPI for machine learning inference, Docker-ized and deployed using Kubernetes</p><div class="font-mono text-sm mt-3 space-x-4"><span class=text-muted>Feb 28, 2023</span>
<span class=text-muted>5 min read</span></div><div class="border-t border-gray my-8 pt-4"><h2 id=tldr>TL;DR</h2><ul><li><a href=https://fastapi.tiangolo.com/>FastAPI</a> is a great way to quickly get a REST API running in development for machine learning model inference.</li><li>It&rsquo;s easy to Dockerize it and deploy it to Kubernetes for production.</li><li>It uses Python types to automatically do validation and generate OpenAPI docs that are interactive.</li><li>Here&rsquo;s a demo repo: <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference>BrianSigafoos/docker-fastapi-ml-inference</a> that should be fully working locally and is deployable to Kubernetes as well</li><li>It easy to follow security best practices for Kubernetes, including running as a non-root user on an immutable file system</li></ul><h2 id=why-fastapi>Why FastAPI?</h2><p><a href=https://fastapi.tiangolo.com/>FastAPI</a> is fast to build, iterate, and deploy.
It uses Python types to automatically do validation and generate OpenAPI docs that are interactive.
For machine learning model inference, it&rsquo;s a great way to quickly get a REST API running in development.
It&rsquo;s also easy and fast to Dockerize it and deploy it to Kubernetes for production.</p><h2 id=the-power-of-python-type-hints>The power of Python type hints</h2><p>From the <a href=https://fastapi.tiangolo.com/python-types/#type-hints-in-fastapi>FastAPI docs</a>:</p><p>By declaring parameters with type hints, you get:</p><ul><li>Editor support</li><li>Type checks</li></ul><p>And FastAPI uses the same declarations to:</p><ul><li>Define requirements: request path parameters, query parameters, etc.</li><li>Convert data: from the request to the required type</li><li>Validate data: coming from each request:</li><li>Generate automatic errors returned to the client when the data is invalid.</li><li>Document the API using OpenAPI in an interactive UI, ie no need for Postman, just use your browser to test the API</li></ul><h2 id=fastapi-setup>FastAPI setup</h2><p>Check our <code>main.py</code> in the demo repo <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference/blob/main/app/main.py>here</a>
for this example of setting up FastAPI with a redirect to the auto-built /docs.</p><p>Plus 2 simple health check endpoints, one for the load balancer and one for the app.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>os</span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>datetime</span> <span style=color:#6ab825;font-weight:700>import</span> datetime, timezone
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>fastapi</span> <span style=color:#6ab825;font-weight:700>import</span> FastAPI
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>starlette.responses</span> <span style=color:#6ab825;font-weight:700>import</span> RedirectResponse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>app.env</span> <span style=color:#6ab825;font-weight:700>import</span> load_env_vars
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app = FastAPI()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>load_env_vars()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>booted_at = {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:orange>@app.on_event</span>(<span style=color:#ed9d13>&#34;startup&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>startup_event</span>():
</span></span><span style=display:flex><span>    booted_at[<span style=color:#ed9d13>&#34;time&#34;</span>] = datetime.now(timezone.utc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Redirect base url to /docs</span>
</span></span><span style=display:flex><span><span style=color:orange>@app.get</span>(<span style=color:#ed9d13>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>redirect_to_docs</span>():
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>return</span> RedirectResponse(url=<span style=color:#ed9d13>&#34;/docs&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:orange>@app.get</span>(<span style=color:#ed9d13>&#34;/health_check&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>health_check</span>():
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;aws_region&#34;</span>: os.environ.get(<span style=color:#ed9d13>&#34;AWS_REGION&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;booted_at&#34;</span>: booted_at.get(<span style=color:#ed9d13>&#34;time&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;health&#34;</span>: <span style=color:#ed9d13>&#34;OK&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;k8s_env&#34;</span>: os.environ.get(<span style=color:#ed9d13>&#34;K8S_ENV&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;python_env&#34;</span>: os.environ[<span style=color:#ed9d13>&#34;PYTHON_ENV&#34;</span>],
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;titanic_model_version&#34;</span>: TITANIC_MODEL_VERSION,
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;version&#34;</span>: os.environ.get(
</span></span><span style=display:flex><span>            <span style=color:#ed9d13>&#34;APP_REVISION&#34;</span>, <span style=color:#ed9d13>&#34;Missing $APP_REVISION env var, not set&#34;</span>
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Don&#39;t render JSON for load balancer health check, just return 200</span>
</span></span><span style=display:flex><span><span style=color:orange>@app.get</span>(<span style=color:#ed9d13>&#34;/health_check/load_balancer&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>health_check_load_balancer</span>():
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>return</span>
</span></span></code></pre></div><h2 id=add-an-inference-endpoint>Add an inference endpoint</h2><p>Next in <code>main.py</code> we add an inference endpoint, something like:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:orange>@app.post</span>(
</span></span><span style=display:flex><span>    <span style=color:#ed9d13>&#34;/predict_survival_by_passengers&#34;</span>, response_model=SurvivalPredictionByPassengerIds
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>predict_survival_by_passengers</span>(passengers: <span style=color:#24909d>list</span>[Passenger]):
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic># Convert passengers to a list of dicts; this is what the model expects</span>
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic># There must be a better way to do this.</span>
</span></span><span style=display:flex><span>    passengers = [passenger.dict() <span style=color:#6ab825;font-weight:700>for</span> passenger <span style=color:#6ab825;font-weight:700>in</span> passengers]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic># Make predictions</span>
</span></span><span style=display:flex><span>    results = [] <span style=color:#6ab825;font-weight:700>if</span> <span style=color:#6ab825;font-weight:700>not</span> passengers <span style=color:#6ab825;font-weight:700>else</span> titanic_survival_predict(passengers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;predictions&#34;</span>: results,
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#ed9d13>&#34;titanic_model_version&#34;</span>: TITANIC_MODEL_VERSION,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>That endpoint simply calls the <code>predict()</code> function (here as <code>titanic_survival_predict()</code>) that loads the model and makes predictions. See <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference/blob/main/app/titanic_survival/model.py>demo app for more code</a></p><p>FastAPI handles the type checking, validation, and most errors for us automatically.</p><h2 id=dockerize>Dockerize</h2><p>I&rsquo;ve found <a href=https://python-poetry.org/>poetry</a> to be a best way to manage dependencies and you&rsquo;ll see <code>poetry</code> commands in the <code>Dockerfile</code> below.</p><p>Here&rsquo;s the <code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#999;font-style:italic># Versions with defaults. Override with env var to build a different version.</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>ARG</span> <span style=color:#40ffff>PYTHON_VERSION</span>=<span style=color:#3677a9>3</span>.11<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># More args</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># For security, set a non-root user. Name is arbitrary.</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>ARG</span> <span style=color:#40ffff>USER</span>=nonroot
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>ARG</span> <span style=color:#40ffff>USER_ID</span>=<span style=color:#3677a9>1001</span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>ARG</span> <span style=color:#40ffff>PYTHON_ENV</span>=production
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Use the official lightweight Python image.</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># https://hub.docker.com/_/python</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>FROM</span><span style=color:#ed9d13> python:${PYTHON_VERSION}-slim-buster</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Args needed for this container</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>ARG</span> USER<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>ARG</span> USER_ID<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>ARG</span> PYTHON_ENV<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>ENV</span> <span style=color:#40ffff>PYTHON_ENV</span>=<span style=color:#ed9d13>${</span><span style=color:#40ffff>PYTHON_ENV</span><span style=color:#ed9d13>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Recommended by hadolint</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># https://github.com/hadolint/hadolint/wiki/DL4006</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>SHELL</span> [<span style=color:#ed9d13>&#34;/bin/bash&#34;</span>, <span style=color:#ed9d13>&#34;-o&#34;</span>, <span style=color:#ed9d13>&#34;pipefail&#34;</span>, <span style=color:#ed9d13>&#34;-c&#34;</span>]<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Add non-root user</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>RUN</span> groupadd --gid <span style=color:#40ffff>$USER_ID</span> <span style=color:#40ffff>$USER</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>  &amp;&amp; useradd --uid <span style=color:#40ffff>$USER_ID</span> --gid <span style=color:#40ffff>$USER</span> --shell /bin/bash --create-home <span style=color:#40ffff>$USER</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Create a directory for the app code</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>RUN</span> mkdir /app <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>  &amp;&amp; chown -R <span style=color:#40ffff>$USER</span>:<span style=color:#40ffff>$USER</span> /app<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>WORKDIR</span><span style=color:#ed9d13> /app</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Copy dependency definitions for production-only requirements</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>COPY</span> --chown=<span style=color:#40ffff>$USER</span>:<span style=color:#40ffff>$USER</span> pyproject.toml ./pyproject.toml<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Install poetry</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>RUN</span> pip install poetry<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Don&#39;t create a virtualenv, we&#39;ll use the container&#39;s python so everything else just works</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>RUN</span> poetry config virtualenvs.create false<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Install production-only dependencies</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>RUN</span> poetry install --without dev,test<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># COPY the app code that is needed to start the server and run the app</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># This will be at `app/app` in the container.</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>COPY</span> --chown=<span style=color:#40ffff>$USER</span>:<span style=color:#40ffff>$USER</span> app app<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>COPY</span> --chown=<span style=color:#40ffff>$USER</span>:<span style=color:#40ffff>$USER</span> .env.production .env.production<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># Set user to non-root $USER</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># This needs to be the numeric uid, not the username, for the k8s</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># securityContext: runAsNonRoot check to work.</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>USER</span><span style=color:#ed9d13> $USER_ID</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#999;font-style:italic># https://www.uvicorn.org/deployment/</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#6ab825;font-weight:700>CMD</span> [<span style=color:#ed9d13>&#34;uvicorn&#34;</span>, <span style=color:#ed9d13>&#34;app.main:app&#34;</span>, <span style=color:#ed9d13>&#34;--host&#34;</span>, <span style=color:#ed9d13>&#34;0.0.0.0&#34;</span>, <span style=color:#ed9d13>&#34;--port&#34;</span>, <span style=color:#ed9d13>&#34;80&#34;</span>]<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span></code></pre></div><h2 id=kubernetes-deployment-and-security-best-practices>Kubernetes deployment and security best practices</h2><p>Assuming you already have an existing Kubernetes cluster, it&rsquo;s straightforward to deploy this app. Check out the demo app&rsquo;s <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference/blob/main/kubernetes>kubernetes/</a> directory for the deployment and service specs.</p><p>I always recommend following the <a href=https://www.nsa.gov/News-Features/Feature-Stories/Article-View/Article/2716980/nsa-cisa-release-kubernetes-hardening-guidance/>NSA/CISA Kubernetes Hardening Guidance</a> as much as possible.</p><p>In the demo app, you&rsquo;ll notice it follows some key security recommendations:</p><ul><li>Use containers built to run applications as non-root users (see the Dockerfile for &ldquo;nonroot&rdquo; USER setup and USER_ID)</li><li>Where possible, run containers with immutable file systems</li><li>Preventing privileged containers</li><li>Rejecting containers that execute as the root user or allow elevation to root</li></ul><p>The <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference>demo app</a> does the checked ones above and everyone really should. They&rsquo;re straightforward to implement.
See the Dockerfile for &ldquo;nonroot&rdquo; USER setup and USER_ID</p><p>The other parts are as simple as passing some options in the <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference/blob/main/kubernetes/base/deployment.yaml>K8s Deployment spec</a></p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6ab825;font-weight:700>spec</span>:<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>securityContext</span>:<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>    </span><span style=color:#999;font-style:italic># Must match Dockerfile&#39;s USER_ID for User and Group</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>runAsUser</span>:<span style=color:#666> </span><span style=color:#3677a9>1001</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>runAsGroup</span>:<span style=color:#666> </span><span style=color:#3677a9>1001</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>    </span><span style=color:#999;font-style:italic># Set ownership of mounted volumes to the user running the container</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>fsGroup</span>:<span style=color:#666> </span><span style=color:#3677a9>1001</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>  </span><span style=color:#999;font-style:italic># https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#container-v1-core</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>containers</span>:<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>    </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>demo-fastapi-ml-container<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>image</span>:<span style=color:#666> </span>ghcr.io/briansigafoos/docker-fastapi-ml-inference<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>securityContext</span>:<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>false</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>readOnlyRootFilesystem</span>:<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>true</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>runAsNonRoot</span>:<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>true</span><span style=color:#666>
</span></span></span></code></pre></div><h2 id=wrapping-up>Wrapping up</h2><p>FastAPI is a great framework for building APIs, including for machine learning model inference. It&rsquo;s easy to use, has great documentation, and is fast. It&rsquo;s also easy to Dockerize and to deploy to Kubernetes.</p><p>Check out the <a href=https://github.com/BrianSigafoos/docker-fastapi-ml-inference>demo app code</a> and let me know what you think.</p><div class="border-t border-b border-gray text-muted my-8 py-4">Read more posts like this in the
<a href=/software-engineering-toolbox>Software Engineering Toolbox</a> collection.</div></div><div class=my-8><a href=https://briansigafoos.com/ class="text-base inline-block mb-1 py-2 px-6 cursor-pointer font-mono font-bold text-primary border border-solid border-primary bg-bright no-underline">Visit homepage</a></div><div class=my-8><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//briansigafoos.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class="border-t border-gray py-4 my-16 w-full text-sm text-faint"><div class="container max-w-4xl text-center font-mono"><div class="sm:flex items-center justify-between"><span>Made with
<a href=https://gohugo.io rel=nofollow target=hugo class=underline>Hugo</a> &
        <a href=https://tailwindcss.com rel=nofollow target=tw class=underline>TailwindCSS</a>
·
<a href=https://github.com/BrianSigafoos/hugo_site rel=nofollow target=source class=underline>Source code
</a></span><span class="block sm:inline mt-2 sm:mt-0">By <a href=/about class="text-primary font-black">Brian Sigafoos</a></span></div></div></div></body></html>