<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><title>Machine Learning quick start - Brian Sigafoos</title><link rel=stylesheet href="/css/main.min.67f30afe326a13bc9b404bcb6c7069ec605ce918aa5102a8d63934b4e0b8fac4.css" integrity="sha256-Z/MK/jJqE7ybQEvLbHBp7GBc6RiqUQKo1jk0tOC4+sQ="><script src=/main.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-42740116-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel="shortcut icon" href=/favicon.png?20190809><link rel=apple-touch-icon href=/apple-touch-icon.png?20190809></head><body data-controller=color-scheme class="text-color bg-bright antialiased leading-normal"><div class="border-b border-gray py-4 w-full"><div class="container max-w-4xl"><div class="flex items-center justify-between font-mono"><a href=https://briansigafoos.com/ class="text-primary font-extrabold">Brian Sigafoos</a><div class="flex items-center"><a href=/about class="text-color font-extrabold block">About me</a><div class="flex ml-4"><button type=button data-action=color-scheme#toggleScheme aria-label="Toggle dark mode" title="Toggle dark mode" class="py-1 px-2 cursor-pointer text-color"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg></button>
<button type=button data-action=color-scheme#toggleColor aria-label="Change primary color" title="Change primary color" class="py-1 px-2 cursor-pointer text-primary"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828.0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg></button></div></div></div></div></div><div class="container my-12 md:my-16 !max-w-4xl prose md:prose-lg lg:prose-xl prose-custom"><h1>Machine Learning quick start</h1><p class="mt-4 text-lg md:text-xl lg:text-2xl text-muted">Learn how to quickly get started using fastai, Hugging Face, and Gradio to deploy a demo ML app</p><div class="font-mono text-sm mt-3 space-x-4"><span class=text-muted>Dec 21, 2022</span>
<span class=text-muted>4 min read</span></div><div class="border-t border-gray my-8 pt-4"><h2 id=intro>Intro</h2><p>This &ldquo;quick start&rdquo; is based on the outstanding course by fast.ai: <a href=https://course.fast.ai>Practical Deep Learning for Coders</a>.</p><p>Follow these steps to properly install Python and deploy a demo ML app on Hugging Face, using Gradio.</p><p>Here&rsquo;s my example demo app: <a href=https://briansigafoos-fastai-trees.hf.space>tree leaf classifier app</a> (<a href=https://huggingface.co/spaces/BrianSigafoos/fastai_trees/tree/main>source code</a>)</p><h2 id=development-setup>Development setup</h2><p>Install Python using <a href=https://mamba.readthedocs.io>mamba</a>. Anywhere you see instructions for <code>conda</code>, you can use <code>mamba</code> instead (it&rsquo;s faster). Why not <code>pip</code>? If you&rsquo;re doing ML, <code>mamba</code>/<code>conda</code> makes it easier to have everything you need (including Python), and to optimize packages for your GPU.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-style:italic># First:</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Install mamba for your machine: https://github.com/conda-forge/miniforge#mambaforge</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Or use this script: https://github.com/fastai/fastsetup/blob/master/setup-conda.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Then:</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># https://github.com/fastai/fastai/</span>
</span></span><span style=display:flex><span>mamba install -y -c fastchan fastai
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Jupyter notebooks</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># https://github.com/jupyter/notebook</span>
</span></span><span style=display:flex><span>mamba install -y -c fastchan notebook jupyter ipywidgets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Start notebook, will auto-open in web browser</span>
</span></span><span style=display:flex><span>jupyter notebook
</span></span></code></pre></div><p>Personally, I prefer using <a href=https://code.visualstudio.com/>VSCode</a> for viewing, editing, and running Jupyter Notebooks. So, you can skip that last <code>jupyter notebook</code> step above.</p><h2 id=create-a-hugging-face-account>Create a Hugging Face account</h2><p>Go to <a href=https://huggingface.co/>Hugging Face</a> and create an account.</p><p>Then create a <a href=https://huggingface.co/new-space>new Space</a> and select Gradio (other options: MIT license, Public)</p><p>Then <code>git clone</code> your new space to your local machine, following their instructions.</p><p>Next, install the Hugging Face CLI.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mamba install -c fastchan huggingface_hub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Log in to HF so you can `git push` your changes to your repo</span>
</span></span><span style=display:flex><span>huggingface-cli login
</span></span></code></pre></div><h2 id=watch-the-fastai-course-lessons>Watch the fast.ai course lessons</h2><p>From <a href=https://course.fast.ai>Practical Deep Learning for Coders</a>, watch lesson 1 and <a href=https://course.fast.ai/Lessons/lesson2.html>lesson 2</a> especially.</p><h2 id=train-a-simple-classifier-model>Train a simple classifier model</h2><p>See <code>train.ipynb</code> in my demo classifier for reference: <a href=https://huggingface.co/spaces/BrianSigafoos/fastai_trees/tree/main>https://huggingface.co/spaces/BrianSigafoos/fastai_trees/tree/main</a></p><p>Once you run the model in your code locally, and output the <code>model.pkl</code> file you&rsquo;ll be ready to run <code>app.ipynb</code>, and use that outputted model.</p><p>But first, this is a good time to make sure you have <a href=https://git-lfs.com/><code>git-lfs</code></a> set up:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-style:italic># Install git-lfs</span>
</span></span><span style=display:flex><span>brew install git-lfs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git lfs install
</span></span><span style=display:flex><span>git lfs track <span style=color:#ed9d13>&#34;*.pkl&#34;</span>
</span></span><span style=display:flex><span>git add .gitattributes
</span></span><span style=display:flex><span>git commit -m <span style=color:#ed9d13>&#34;update .gitattributes so git lfs will track .pkl files&#34;</span>
</span></span></code></pre></div><h2 id=launch-a-gradio-app>Launch a Gradio app</h2><p>See <code>app.ipynb</code> to go from your output <code>model.pkl</code> to a published classifier app.</p><p>Make sure you have <code>nbdev</code> installed. This will help turn a working Jupyter notebook into an <code>app.py</code> file that the Hugging Face space will use to power your app using Gradio.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#999;font-style:italic># https://github.com/fastai/nbdev/</span>
</span></span><span style=display:flex><span>mamba install -c fastchan nbdev
</span></span></code></pre></div><p>Note all the comments that start with <code>#|</code> in the <code>app.ipynb</code> file: <a href=https://huggingface.co/spaces/BrianSigafoos/fastai_trees/tree/main>https://huggingface.co/spaces/BrianSigafoos/fastai_trees/tree/main</a></p><p>Everything with <code>#|export</code> will be dumped into your <code>app.py</code> file.</p><p>Once you <code>git push</code> these changes, including the generated <code>app.py</code> (from the <code>nb_export</code> cell), you should have your app now published and running on Hugging Face Spaces.</p><h2 id=use-the-hugging-face-api-backend>Use the Hugging Face API backend</h2><p>A great Hugging Face feature is the ability to use it&rsquo;s API backend with your own frontend.</p><p>From the bottom of your running app, click &ldquo;Use the API&rdquo; to bring up the API instructions. For example, from my demo app: <a href="https://briansigafoos-fastai-trees.hf.space/?view=api">https://briansigafoos-fastai-trees.hf.space/?view=api</a></p><h3 id=live-demo>Live demo</h3><p>Select one or many images of a tree leaves. Ideally, pick of these 5 types of tree leaves that this demo model has been trained on:
ash, chestnut, ginkgo biloba, silver maple, or willow oak.</p><input id=predict_photos type=file multiple><div id=predict_results></div><script>HF_PREDICT_ENDPOINT="https://briansigafoos-fastai-trees.hf.space/run/predict/";async function get_pred(e){return new Promise(async t=>{const n=new FileReader;n.onload=async()=>{data=JSON.stringify({data:[n.result]}),post={method:"POST",body:data,headers:{"Content-Type":"application/json"}};const a=await fetch(HF_PREDICT_ENDPOINT,post),r=await a.json(),s=r.data[0],e=s.confidences[0],c=parseFloat(e.confidence*100).toFixed(2),o=s.confidences[1],l=parseFloat(o.confidence*100).toFixed(2),i=document.createElement("div");return i.innerHTML=`
          <img class="prediction" src="${n.result}" width="300">
          <p>
            ${e.label} - ${c}%
            (${o.label} - ${l}%)
          </p>
        `,predict_results.append(i),t(e)},n.readAsDataURL(e)})}predict_photos.addEventListener("input",async()=>{predict_results.innerHTML="",await Promise.allSettled([...predict_photos.files].map(get_pred))})</script><h3 id=code-for-demo-above>Code for demo above</h3><p>Below is the Javascript (and HTML) that fully powers the demo above, using the Hugging Face backend API to return the results.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#6ab825;font-weight:700>input</span> <span style=color:#bbb>id</span>=<span style=color:#ed9d13>&#34;predict_photos&#34;</span> <span style=color:#bbb>type</span>=<span style=color:#ed9d13>&#34;file&#34;</span> <span style=color:#bbb>multiple</span>=<span style=color:#ed9d13>&#34;&#34;</span> /&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#6ab825;font-weight:700>div</span> <span style=color:#bbb>id</span>=<span style=color:#ed9d13>&#34;predict_results&#34;</span>&gt;&lt;/<span style=color:#6ab825;font-weight:700>div</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#6ab825;font-weight:700>script</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#999;font-style:italic>// Replace with your own HF Space&#39;s /predict endpoint
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  HF_PREDICT_ENDPOINT =
</span></span><span style=display:flex><span>    <span style=color:#ed9d13>&#39;https://briansigafoos-fastai-trees.hf.space/run/predict/&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>async</span> <span style=color:#6ab825;font-weight:700>function</span> get_pred(file) {
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>new</span> <span style=color:#24909d>Promise</span>(<span style=color:#6ab825;font-weight:700>async</span> (resolve) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>const</span> reader = <span style=color:#6ab825;font-weight:700>new</span> FileReader()
</span></span><span style=display:flex><span>      reader.onload = <span style=color:#6ab825;font-weight:700>async</span> () =&gt; {
</span></span><span style=display:flex><span>        data = JSON.stringify({ data: [reader.result] })
</span></span><span style=display:flex><span>        post = {
</span></span><span style=display:flex><span>          method: <span style=color:#ed9d13>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>          body: data,
</span></span><span style=display:flex><span>          headers: { <span style=color:#ed9d13>&#39;Content-Type&#39;</span>: <span style=color:#ed9d13>&#39;application/json&#39;</span> }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> response = <span style=color:#6ab825;font-weight:700>await</span> fetch(HF_PREDICT_ENDPOINT, post)
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> json = <span style=color:#6ab825;font-weight:700>await</span> response.json()
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> results = json[<span style=color:#ed9d13>&#39;data&#39;</span>][<span style=color:#3677a9>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> prediction = results[<span style=color:#ed9d13>&#39;confidences&#39;</span>][<span style=color:#3677a9>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> predictionConfidence = <span style=color:#24909d>parseFloat</span>(
</span></span><span style=display:flex><span>          prediction[<span style=color:#ed9d13>&#39;confidence&#39;</span>] * <span style=color:#3677a9>100</span>
</span></span><span style=display:flex><span>        ).toFixed(<span style=color:#3677a9>2</span>)
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> altPrediction = results[<span style=color:#ed9d13>&#39;confidences&#39;</span>][<span style=color:#3677a9>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> altPredictionConfidence = <span style=color:#24909d>parseFloat</span>(
</span></span><span style=display:flex><span>          altPrediction[<span style=color:#ed9d13>&#39;confidence&#39;</span>] * <span style=color:#3677a9>100</span>
</span></span><span style=display:flex><span>        ).toFixed(<span style=color:#3677a9>2</span>)
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>const</span> div = <span style=color:#24909d>document</span>.createElement(<span style=color:#ed9d13>&#39;div&#39;</span>)
</span></span><span style=display:flex><span>        div.innerHTML = <span style=color:#ed9d13>`
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>          &lt;img class=&#34;prediction&#34; src=&#34;</span><span style=color:#ed9d13>${</span>reader.result<span style=color:#ed9d13>}</span><span style=color:#ed9d13>&#34; width=&#34;300&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>          &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>            </span><span style=color:#ed9d13>${</span>prediction[<span style=color:#ed9d13>&#39;label&#39;</span>]<span style=color:#ed9d13>}</span><span style=color:#ed9d13> - </span><span style=color:#ed9d13>${</span>predictionConfidence<span style=color:#ed9d13>}</span><span style=color:#ed9d13>%
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>            (</span><span style=color:#ed9d13>${</span>altPrediction[<span style=color:#ed9d13>&#39;label&#39;</span>]<span style=color:#ed9d13>}</span><span style=color:#ed9d13> - </span><span style=color:#ed9d13>${</span>altPredictionConfidence<span style=color:#ed9d13>}</span><span style=color:#ed9d13>%)
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>          &lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        `</span>
</span></span><span style=display:flex><span>        predict_results.append(div)
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>return</span> resolve(prediction)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      reader.readAsDataURL(file)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  predict_photos.addEventListener(<span style=color:#ed9d13>&#39;input&#39;</span>, <span style=color:#6ab825;font-weight:700>async</span> () =&gt; {
</span></span><span style=display:flex><span>    predict_results.innerHTML = <span style=color:#ed9d13>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>await</span> <span style=color:#24909d>Promise</span>.allSettled([...predict_photos.files].map(get_pred))
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>&lt;/<span style=color:#6ab825;font-weight:700>script</span>&gt;
</span></span></code></pre></div><p>The snippet above is based on this code in <a href=https://github.com/fastai/tinypets/blob/638528a157fef9d7a1951dcd31592f19ddbe28d6/3parallel.html><code>fastai/tinypets</code></a> for parallel predictions.</p><h2 id=references>References</h2><ul><li><a href=https://course.fast.ai/>fast.ai course</a></li><li><a href=https://huggingface.co/docs/huggingface_hub/quick-start>Hugging Face Quick Start</a></li><li><a href=https://gradio.app/docs/>Gradio app docs</a></li></ul><div class="border-t border-b border-gray text-muted my-8 py-4">Read more posts like this in the
<a href=/software-engineering-toolbox>Software Engineering Toolbox</a> collection.</div></div><div class=my-8><a href=https://briansigafoos.com/ class="text-base inline-block mb-1 py-2 px-6 cursor-pointer font-mono font-bold text-primary border border-solid border-primary bg-bright no-underline">Visit homepage</a></div><div class=my-8><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//briansigafoos.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class="border-t border-gray py-4 my-16 w-full text-sm text-faint"><div class="container max-w-4xl text-center font-mono"><div class="sm:flex items-center justify-between"><span>Made with
<a href=https://gohugo.io rel=nofollow target=hugo class=underline>Hugo</a> &
        <a href=https://tailwindcss.com rel=nofollow target=tw class=underline>TailwindCSS</a>
·
<a href=https://github.com/BrianSigafoos/hugo_site rel=nofollow target=source class=underline>Source code</a></span>
<span class="block sm:inline mt-2 sm:mt-0">By <a href=/about class="text-primary font-black">Brian Sigafoos</a></span></div></div></div></body></html>